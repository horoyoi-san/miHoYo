use crate::utils::time;
use net_msg::pb::{PlayerHeartBeatCsReq, PlayerHeartBeatScRsp, ClientDownloadData};
use net_msg::{dec, Trait};
use rbase64;

pub async fn handle(req: &[u8]) -> Vec<u8> {
    let req = dec!(PlayerHeartBeatCsReq, req);

    PlayerHeartBeatScRsp {
        download_data: Some(ClientDownloadData {
            version: 51,
            time: time::cur_timestamp_ms() as i64,
            data: rbase64::decode("bG9jYWwgZnVuY3Rpb24gYmV0YV90ZXh0KCkKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIlVJUm9vdC9BYm92ZURpYWxvZy9CZXRhSGludERpYWxvZyhDbG9uZSkiKQogICAgZ2FtZU9iamVjdC50cmFuc2Zvcm0ubG9jYWxQb3NpdGlvbiA9IENTLlVuaXR5RW5naW5lLlZlY3RvcjMoLTEwLCAxMCwgMCkKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTG9jYWxpemVkVGV4dCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHVpZCA9IHRleHRDb21wb25lbnQudGV4dDsKICAgICAgICAgICAgdGV4dENvbXBvbmVudC50ZXh0ID0gJzxzaXplPTE2PiA8Y29sb3I9I2ZmMDQwMD5UPC9jb2xvcj48Y29sb3I9I2ZmMDQwMD5oPC9jb2xvcj48Y29sb3I9I2ZmZmZmZj5hPC9jb2xvcj48Y29sb3I9IzAwMGRmZj5pPC9jb2xvcj48Y29sb3I9IzAwMGRmZj5sPC9jb2xvcj48Y29sb3I9I2ZmZmZmZj5hPC9jb2xvcj48Y29sb3I9I2ZmMDQwMD5uPC9jb2xvcj48Y29sb3I9I2ZmMDQwMD5kPC9jb2xvcj58PGNvbG9yPSNmZjAwMDA+SG9yb3lvaS1zYW4gU1I8L2NvbG9yPjwvc2l6ZT4nCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgpsb2NhbCBmdW5jdGlvbiB2ZXJzaW9uX3RleHQoKQogICAgbG9jYWwgZ2FtZU9iamVjdCA9IENTLlVuaXR5RW5naW5lLkdhbWVPYmplY3QuRmluZCgiVmVyc2lvblRleHQiKQogICAgaWYgZ2FtZU9iamVjdCB0aGVuCiAgICAgICAgbG9jYWwgdGV4dENvbXBvbmVudCA9IGdhbWVPYmplY3Q6R2V0Q29tcG9uZW50SW5DaGlsZHJlbih0eXBlb2YoQ1MuUlBHLkNsaWVudC5Mb2NhbGl6ZWRUZXh0KSkKICAgICAgICBpZiB0ZXh0Q29tcG9uZW50IHRoZW4KICAgICAgICAgICAgdGV4dENvbXBvbmVudC50ZXh0ID0gJzxzaXplPTEyPiA8Y29sb3I9IzAwNDBmZj5Ib3JveW9pLXNhbiBQUyAzLjAuNXg8L2NvbG9yPjwvc2l6ZT4nCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgpsb2NhbCBmdW5jdGlvbiBtaHlfdGV4dChvYmopCiAgICBsb2NhbCBnYW1lT2JqZWN0ID0gQ1MuVW5pdHlFbmdpbmUuR2FtZU9iamVjdC5GaW5kKCJJRE1BUDEiKQogICAgaWYgZ2FtZU9iamVjdCB0aGVuCiAgICAgICAgbG9jYWwgdGV4dENvbXBvbmVudCA9IGdhbWVPYmplY3Q6R2V0Q29tcG9uZW50SW5DaGlsZHJlbih0eXBlb2YoQ1MuUlBHLkNsaWVudC5NZXNzYWdlQm94RGlhbG9nVXRpbCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHRleHRDb21wb25lbnQuU2hvd0Fib3ZlRGlhbG9nVGV4dCA9IGZhbHNlCiAgICAgICAgZW5kCiAgICBlbmQKZW5kCgp2ZXJzaW9uX3RleHQoKQpiZXRhX3RleHQoKQptaHlfdGV4dCgp").unwrap()
        }),
        client_time_ms: req.client_time_ms,
        server_time_ms: time::cur_timestamp_ms(),
        retcode: 0,
    }
    .encode_to_vec()
}