use crate::utils::time;
use net_msg::pb::{PlayerHeartBeatCsReq, PlayerHeartBeatScRsp, ClientDownloadData};
use net_msg::{dec, Trait};
use rbase64;

pub async fn handle(req: &[u8]) -> Vec<u8> {
    let req = dec!(PlayerHeartBeatCsReq, req);

    PlayerHeartBeatScRsp {
        download_data: Some(ClientDownloadData {
            version: 51,
            time: time::cur_timestamp_ms() as i64,
            data: rbase64::decode("bG9jYWwgZnVuY3Rpb24gYmV0YV90ZXh0KCkKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIlVJUm9vdC9BYm92ZURpYWxvZy9CZXRhSGludERpYWxvZyhDbG9uZSkiKQogICAgZ2FtZU9iamVjdC50cmFuc2Zvcm0ubG9jYWxQb3NpdGlvbiA9IENTLlVuaXR5RW5naW5lLlZlY3RvcjMoLTEwLCAxMCwgMCkKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTG9jYWxpemVkVGV4dCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHVpZCA9IHRleHRDb21wb25lbnQudGV4dDsKICAgICAgICAgICAgdGV4dENvbXBvbmVudC50ZXh0ID0gJzxzaXplPTE2PiA8Y29sb3I9I2ZmMDAwMD4gPC9jb2xvcj48L3NpemU+JwogICAgICAgIGVuZAogICAgZW5kCmVuZAoKbG9jYWwgZnVuY3Rpb24gdmVyc2lvbl90ZXh0KCkKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIlZlcnNpb25UZXh0IikKICAgIGlmIGdhbWVPYmplY3QgdGhlbgogICAgICAgIGxvY2FsIHRleHRDb21wb25lbnQgPSBnYW1lT2JqZWN0OkdldENvbXBvbmVudEluQ2hpbGRyZW4odHlwZW9mKENTLlJQRy5DbGllbnQuTG9jYWxpemVkVGV4dCkpCiAgICAgICAgaWYgdGV4dENvbXBvbmVudCB0aGVuCiAgICAgICAgICAgIHRleHRDb21wb25lbnQudGV4dCA9ICAnPHNpemU9MTY+IDxjb2xvcj0jZmYwNDAwPlQ8L2NvbG9yPjxjb2xvcj0jZmYwNDAwPmg8L2NvbG9yPjxjb2xvcj0jZmZmZmZmPmE8L2NvbG9yPjxjb2xvcj0jMDAwZGZmPmk8L2NvbG9yPjxjb2xvcj0jMDAwZGZmPmw8L2NvbG9yPjxjb2xvcj0jZmZmZmZmPmE8L2NvbG9yPjxjb2xvcj0jZmYwNDAwPm48L2NvbG9yPjxjb2xvcj0jZmYwNDAwPmQ8L2NvbG9yPnw8Y29sb3I9IzAwZjJmZj5Ib3JveW9pLXNhbiBTUjwvY29sb3I+PC9zaXplPicKICAgICAgICBlbmQKICAgIGVuZAplbmQKCmxvY2FsIGZ1bmN0aW9uIG1oeV90ZXh0KG9iaikKICAgIGxvY2FsIGdhbWVPYmplY3QgPSBDUy5Vbml0eUVuZ2luZS5HYW1lT2JqZWN0LkZpbmQoIklETUFQMSIpCiAgICBpZiBnYW1lT2JqZWN0IHRoZW4KICAgICAgICBsb2NhbCB0ZXh0Q29tcG9uZW50ID0gZ2FtZU9iamVjdDpHZXRDb21wb25lbnRJbkNoaWxkcmVuKHR5cGVvZihDUy5SUEcuQ2xpZW50Lk1lc3NhZ2VCb3hEaWFsb2dVdGlsKSkKICAgICAgICBpZiB0ZXh0Q29tcG9uZW50IHRoZW4KICAgICAgICAgICAgdGV4dENvbXBvbmVudC5TaG93QWJvdmVEaWFsb2dUZXh0ID0gZmFsc2UKICAgICAgICBlbmQKICAgIGVuZAplbmQKCnZlcnNpb25fdGV4dCgpCmJldGFfdGV4dCgpCm1oeV90ZXh0KCk=").unwrap()
        }),
        client_time_ms: req.client_time_ms,
        server_time_ms: time::cur_timestamp_ms(),
        retcode: 0,
    }
    .encode_to_vec()
}
